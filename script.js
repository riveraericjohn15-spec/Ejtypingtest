const paragraphs = {
  easy: [
    "Bitcoin is a digital currency that works without a central authority. It was created by an anonymous person named Satoshi Nakamoto in 2009. Bitcoin is decentralized, meaning no government or financial institution controls it. People use Bitcoin for online payments and investments because it is faster, cheaper, and borderless. Bitcoin operates on a technology called blockchain, which is a public ledger that records all transactions made with the currency.",
    "Cryptocurrency is a type of digital money. It works on a technology called blockchain, which ensures that all transactions are secure and transparent. Bitcoin is the most popular cryptocurrency, but there are many others like Ethereum and Litecoin. People can buy cryptocurrencies and use them to make payments or invest in them for potential profit. The rise of cryptocurrencies has created a new digital economy that operates outside of traditional banking systems.",
    "Ethereum is another form of cryptocurrency. It was created in 2015 by Vitalik Buterin and allows users to build decentralized applications (dApps) using its blockchain. Ethereum uses smart contracts, which are self-executing contracts that automatically carry out terms. Ethereum has become popular because it supports a wide range of applications beyond just digital money, such as gaming and decentralized finance (DeFi).",
    "Litecoin is a cryptocurrency similar to Bitcoin. It was created in 2011 by Charlie Lee, a former Google engineer. Litecoin is based on Bitcoin’s code but has a few improvements, including faster transaction speeds. Litecoin is often referred to as the 'silver' to Bitcoin's 'gold.' Despite being less popular than Bitcoin, Litecoin has a strong following and is widely accepted by merchants as a method of payment.",
    "Blockchain is a technology that stores information across a network of computers. It ensures transparency and security by making data publicly accessible and difficult to alter. Each block in a blockchain contains a set of transactions, and once a block is added, it cannot be changed. This makes blockchain a useful tool for a variety of applications, including cryptocurrency, supply chain management, and even voting systems.",
    "Cryptocurrencies are a new form of digital money that allows people to make secure transactions without the need for banks. Bitcoin, Ethereum, and other cryptocurrencies rely on blockchain technology to store data safely and transparently. The value of cryptocurrencies can rise and fall dramatically, depending on factors like market demand, investor sentiment, and news about regulations.",
    "Bitcoin mining is the process of creating new Bitcoin by solving complex mathematical problems. Miners use powerful computers to perform these calculations, and in return, they are rewarded with new Bitcoin. This process helps secure the Bitcoin network and maintain the integrity of its blockchain. However, mining requires significant energy resources, leading to debates about its environmental impact."
  ],
  medium: [
    "The concept of decentralized finance (DeFi) is transforming traditional financial services by enabling peer-to-peer transactions without the need for banks. DeFi applications are built on blockchain technology, and they allow users to borrow, lend, trade, and invest directly with one another. Smart contracts, which are self-executing contracts that automatically carry out terms, make DeFi possible. While DeFi offers numerous benefits, it is still a relatively new concept with risks such as hacking and regulatory uncertainty.",
    "Ethereum's blockchain is more than just a cryptocurrency. It is a platform that enables developers to build decentralized applications (dApps). These apps run on Ethereum's blockchain, eliminating the need for central authorities or intermediaries. Smart contracts are a core feature of Ethereum and help automate processes. The Ethereum network has become the foundation for various industries, including finance, supply chain, and gaming. However, Ethereum faces challenges like scalability and high gas fees, which affect its performance.",
    "In 2021, Bitcoin reached an all-time high price of nearly $65,000. Despite its success, Bitcoin has faced criticism for its environmental impact, as the process of mining Bitcoin requires significant energy. Some have suggested that Bitcoin should transition to a more energy-efficient system, such as Proof of Stake, to reduce its carbon footprint. Meanwhile, the development of alternative cryptocurrencies and blockchain networks has gained momentum, with many seeking to create more scalable and eco-friendly solutions.",
    "Blockchain technology has revolutionized the way we think about digital transactions. It is a decentralized, distributed ledger that stores data across a network of computers. Once data is added to the blockchain, it cannot be altered or deleted. This makes blockchain highly secure and resistant to fraud. Many industries are adopting blockchain for use cases such as secure data sharing, identity verification, and supply chain tracking. However, blockchain faces challenges like scalability, high energy consumption, and regulatory uncertainty.",
    "The rise of NFTs (non-fungible tokens) has changed the way people think about digital art and ownership. NFTs are unique digital assets that are stored on a blockchain, making them verifiable and impossible to duplicate. Artists and creators can mint their own NFTs and sell them on platforms like OpenSea and Rarible. While NFTs have created new opportunities for artists, they have also raised concerns about their environmental impact due to the energy consumption of blockchain networks.",
    "Cryptocurrency exchanges allow users to buy, sell, and trade digital currencies. Some of the most popular exchanges include Coinbase, Binance, and Kraken. These platforms provide users with easy access to the cryptocurrency market, offering a wide variety of coins and tokens. However, exchanges are often targeted by hackers, and users must take security precautions, such as enabling two-factor authentication and using cold storage wallets, to protect their assets.",
    "The concept of Proof of Work (PoW) is a fundamental part of Bitcoin and other cryptocurrencies. PoW requires miners to solve complex mathematical problems in order to validate transactions and add them to the blockchain. This process consumes a significant amount of energy and has been criticized for its environmental impact. As a result, some cryptocurrencies are moving towards alternative consensus mechanisms, such as Proof of Stake (PoS), which are more energy-efficient."
  ],
  hard: [
    "DeFi (Decentralized Finance) has become a revolutionary force in the financial industry, allowing users to borrow, lend, and trade digital assets **without intermediaries**. For instance, **Uniswap**, a decentralized exchange, allows users to trade cryptocurrencies directly, utilizing **smart contracts**. In 2021, **DeFi protocols** locked in over $100 billion in assets, but **scalability issues** and **security vulnerabilities** still pose risks. Some platforms have suffered from hacks or **rug pulls** (scams), where the creators withdraw all funds. Therefore, as the **DeFi ecosystem** grows, **security protocols** and **regulations** are crucial to ensure the safety of funds.",
    "Bitcoin's **market capitalization** surged past $1 trillion in early 2021, with the price peaking at nearly $64,000 before experiencing significant **volatility**. This volatility is primarily driven by **market sentiment**, **institutional adoption**, and global **economic factors**. As of Q1 2022, **Bitcoin mining** consumes over **120 terawatt-hours** of electricity annually, surpassing the total energy consumption of some countries. While this has raised concerns about Bitcoin's **environmental impact**, solutions like **Proof of Stake (PoS)** and **Layer 2 scaling solutions** are being developed to address these issues and reduce energy consumption.",
    "Ethereum's **transition to Ethereum 2.0** is one of the most highly anticipated developments in the cryptocurrency space. The upgrade, set to transition Ethereum from **Proof of Work (PoW)** to **Proof of Stake (PoS)**, promises to significantly reduce its **energy consumption**, increase **transaction speeds**, and improve **scalability**. With **Ethereum's market capitalization** surpassing **$400 billion**, its success or failure will greatly influence the future of decentralized technologies. However, the **Ethereum 2.0 upgrade** involves **multiple stages** and **complex technical challenges**, including the implementation of **sharding** and the **transition to POS**, which may take years to fully complete.",
    "The **Blockchain Trilemma** refers to the **challenge** of achieving **scalability**, **security**, and **decentralization** simultaneously. **Bitcoin** solved the decentralization problem, but it struggles with scalability, processing only **7 transactions per second**. **Ethereum** faces similar challenges, processing **~30 transactions per second**, which results in high **gas fees** during times of network congestion. **Layer 2 solutions**, such as **Lightning Network** for Bitcoin and **Optimistic Rollups** for Ethereum, aim to solve this problem by processing transactions off-chain. However, the trade-offs between **decentralization** and **scalability** remain an ongoing debate.",
    "In 2021, **NFTs (Non-Fungible Tokens)** exploded in popularity, with sales surpassing **$10 billion** in Q3 alone. NFTs are unique digital assets stored on a **blockchain**, typically representing digital art, music, or virtual goods. What distinguishes NFTs from traditional cryptocurrencies like Bitcoin is their **uniqueness**. Each NFT has a unique identifier that cannot be replicated. However, NFTs also face criticism for their **environmental impact**. The **energy consumption** associated with **minting NFTs** on **Ethereum** has raised concerns due to the blockchain's **Proof of Work** consensus mechanism. Solutions like **Ethereum 2.0**, which will transition to **Proof of Stake**, aim to address this issue.",
    "The rise of **Central Bank Digital Currencies (CBDCs)** has sparked debates about the future of money. While **cryptocurrencies** like **Bitcoin** and **Ethereum** are decentralized, CBDCs are digital currencies issued and controlled by central banks. Countries like **China** are actively experimenting with **CBDCs**, and the **European Central Bank** has begun exploring the **digital euro**. Although CBDCs could increase **financial inclusion** and reduce the cost of cross-border payments, concerns about **privacy**, **government surveillance**, and the centralization of financial systems remain.",
    "Despite the growth of **cryptocurrencies**, the **volatility** of the market poses challenges for adoption as a mainstream form of payment. In 2021, the price of Bitcoin dropped by more than 50% in just a few months, leading some to question its potential as a store of value. Moreover, **regulatory uncertainty** is a key issue. Governments around the world are working to define how cryptocurrencies should be taxed, whether they should be classified as commodities or currencies, and how they should be regulated. These issues must be addressed for cryptocurrencies to become more stable and widely adopted."
  ]
};

const testTextEl = document.getElementById("test-text");
const inputArea = document.getElementById("input-area");
const timerEl = document.getElementById("timer");
const wpmEl = document.getElementById("wpm");
const accuracyEl = document.getElementById("accuracy");
const levelSelect = document.getElementById("difficulty");
const durationSelect = document.getElementById("duration");
const modal = document.getElementById("result-modal");
const modalText = document.getElementById("modal-text");
const keyboard = document.getElementById("keyboard");

let currentText = "";
let currentWords = [];
let currentLevel = "easy";
let timeLimit = 60;
let startTime = null;
let interval = null;
let wordIndex = 0;
let correctWordCount = 0;
let totalTypedWords = 0;
let typingFinished = false;
let lockedText = "";

function loadNewText() {
  currentText = getRandomText(currentLevel);
  currentWords = currentText.split(" ");
  testTextEl.innerHTML = "";
  currentWords.forEach((word, index) => {
    const wordSpan = document.createElement("span");
    wordSpan.classList.add("word");
    wordSpan.textContent = word;
    if (index < currentWords.length - 1) wordSpan.textContent += " ";
    testTextEl.appendChild(wordSpan);
  });
  resetTestState();
}

function getRandomText(level) {
  const texts = paragraphs[level];
  return texts[Math.floor(Math.random() * texts.length)];
}

function resetTestState() {
  lockedText = "";
  inputArea.value = "";
  inputArea.disabled = false;
  timerEl.textContent = "0";
  wpmEl.textContent = "0";
  accuracyEl.textContent = "100";
  startTime = null;
  wordIndex = 0;
  correctWordCount = 0;
  totalTypedWords = 0;
  typingFinished = false;
  clearInterval(interval);
  highlightCurrentWord();
}

function highlightCurrentWord() {
  const wordSpans = document.querySelectorAll("#test-text .word");
  wordSpans.forEach((word, index) => {
    word.classList.remove("active");
    if (index === wordIndex) word.classList.add("active");
  });
}

function processCurrentWordWithText(typedWord) {
  const expectedWord = currentWords[wordIndex] || "";
  const wordSpans = document.querySelectorAll("#test-text .word");
  if (typedWord === expectedWord) {
    wordSpans[wordIndex].style.color = "green";
    correctWordCount++;
  } else {
    wordSpans[wordIndex].style.color = "red";
  }
  totalTypedWords++;
  wordIndex++;
  if (wordIndex >= currentWords.length) endTest();
  else highlightCurrentWord();
}

inputArea.addEventListener('paste', (e) => {
  e.preventDefault();
  alert('Pasting is disabled in this typing test.');
});

inputArea.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'v') {
    e.preventDefault();
    alert('Oops, too bad. I knew you were going to do it! -ej');
  }
});

inputArea.addEventListener('contextmenu', (e) => {
  e.preventDefault();
});

inputArea.addEventListener("keydown", (e) => {
  if (typingFinished) { e.preventDefault(); return; }
  if (e.key === " " || e.key === "Enter") {
    e.preventDefault();
    const typedWord = inputArea.value.slice(lockedText.length).trim();
    if (!typedWord) return;
    processCurrentWordWithText(typedWord);
    lockedText += typedWord + " ";
    inputArea.value = lockedText;
    setCaretPosition(inputArea, inputArea.value.length);
  } else highlightVirtualKey(e.key);
});

inputArea.addEventListener("input", () => {
  if (!startTime) {
    startTime = Date.now();
    interval = setInterval(() => { updateTimer(); calculateMetrics(); }, 500);
  }
  if (inputArea.selectionStart < lockedText.length) {
    inputArea.value = lockedText + inputArea.value.slice(lockedText.length);
    setCaretPosition(inputArea, inputArea.value.length);
    return;
  }
  const currentTyped = inputArea.value.slice(lockedText.length);
  if (wordIndex === currentWords.length - 1 && currentTyped === currentWords[wordIndex]) {
    lockedText += currentTyped;
    inputArea.value = lockedText;
    inputArea.disabled = true;
    document.querySelectorAll("#test-text .word")[wordIndex].style.color = "green";
    correctWordCount++;
    totalTypedWords++;
    endTest();
  }
});

function calculateMetrics() {
  const elapsedMinutes = (Date.now() - startTime) / 60000;
  const wpm = Math.round(correctWordCount / elapsedMinutes);
  const accuracy = totalTypedWords ? Math.round((correctWordCount / totalTypedWords) * 100) : 100;
  wpmEl.textContent = isNaN(wpm) ? 0 : wpm;
  accuracyEl.textContent = isNaN(accuracy) ? 100 : accuracy;
  return { wpm: isNaN(wpm) ? 0 : wpm, accuracy: isNaN(accuracy) ? 100 : accuracy, timeElapsed: Math.floor(elapsedMinutes * 60) };
}

function updateTimer() {
  const seconds = Math.floor((Date.now() - startTime) / 1000);
  timerEl.textContent = seconds;
  if (seconds >= timeLimit && !typingFinished) endTest();
}

function endTest() {
  typingFinished = true;
  clearInterval(interval);
  inputArea.disabled = true;
  showResult(calculateMetrics());
}

function showResult({ wpm, accuracy, timeElapsed }) {
  modalText.innerHTML = `
    <h2>Results</h2>
    <p><strong>WPM:</strong> ${wpm}</p>
    <p><strong>Accuracy:</strong> ${accuracy}%</p>
    <p><strong>Time:</strong> ${timeElapsed}s</p>
    <button id="try-again-btn">Try Again</button>
    <button id="view-analytics-btn">View Analytics</button>
  `;
  modal.style.display = "flex";
  document.getElementById("try-again-btn").addEventListener("click", () => { modal.style.display = "none"; loadNewText(); });
  document.getElementById("view-analytics-btn").addEventListener("click", () => { modal.style.display = "none"; saveTestResult(wpm, accuracy); });
}

levelSelect.addEventListener("change", () => { currentLevel = levelSelect.value; loadNewText(); });
durationSelect.addEventListener("change", () => { timeLimit = parseInt(durationSelect.value); loadNewText(); });

function createKeyboard() {
  const layout = [["1","2","3","4","5","6","7","8","9","0"],["Q","W","E","R","T","Y","U","I","O","P"],["A","S","D","F","G","H","J","K","L"],["Z","X","C","V","B","N","M"],["Space"]];
  keyboard.innerHTML = "";
  layout.forEach(row => {
    const rowEl = document.createElement("div");
    rowEl.classList.add("key-row");
    row.forEach(key => {
      const keyEl = document.createElement("div");
      keyEl.classList.add("key");
      keyEl.textContent = key;
      keyEl.id = `key-${key.toUpperCase()}`;
      rowEl.appendChild(keyEl);
    });
    keyboard.appendChild(rowEl);
  });
}

function highlightVirtualKey(key) {
  document.querySelectorAll(".key").forEach(k => k.classList.remove("active"));
  if (!key) return;
  let keyId = key.toUpperCase();
  if (key === " ") keyId = "SPACE";
  const el = document.getElementById(`key-${keyId}`);
  if (el) el.classList.add("active");
}

function setCaretPosition(elem, pos) {
  if (elem.setSelectionRange) { elem.focus(); elem.setSelectionRange(pos, pos); }
}

let topScores = JSON.parse(localStorage.getItem('topScores')) || [];

function getSpeedCategory(wpm) {
  if (wpm < 20) return 'Beginner';
  if (wpm < 40) return 'Average';
  return 'Fast';
}

function showAnalytics(latestResult, isCurrent = true) {
  const rankingBars = document.getElementById("ranking-bars");
  rankingBars.innerHTML = "";
  const allResults = [...topScores, { ...latestResult, current: true }];
  allResults.sort((a, b) => b.wpm - a.wpm);
  allResults.forEach((res, index) => {
    const barWrapper = document.createElement("div"); barWrapper.className = "ranking-bar";
    const label = document.createElement("div"); label.className = "ranking-label"; label.textContent = res.current ? "Now" : "Top " + (index+1);
    const fill = document.createElement("div"); fill.className = "ranking-fill"; fill.style.width = Math.min(res.wpm, 100) + "%"; if(res.current) fill.style.background = "linear-gradient(90deg, cyan, #00e5ff)";
    const value = document.createElement("div"); value.className = "ranking-value"; value.textContent = `${res.wpm} WPM`;
    barWrapper.appendChild(label); barWrapper.appendChild(fill); barWrapper.appendChild(value); rankingBars.appendChild(barWrapper);
  });
  const wpmBar = document.getElementById('wpm-bar'); const accuracyBar = document.getElementById('accuracy-bar');
  wpmBar.style.width = "0%"; accuracyBar.style.width = "0%";
  setTimeout(() => { wpmBar.style.width = Math.min(latestResult.wpm, 100) + "%"; wpmBar.textContent = `${latestResult.wpm} WPM`; accuracyBar.style.width = latestResult.accuracy + "%"; accuracyBar.textContent = `${latestResult.accuracy}%`; }, 100);
  document.getElementById('speed-category').textContent = `Category: ${getSpeedCategory(latestResult.wpm)}`;
  document.getElementById('analytics-modal').style.display = 'flex';
}

function closeAnalytics() { document.getElementById('analytics-modal').style.display = 'none'; loadNewText(); }
document.getElementById('analytics-close-btn').addEventListener('click', closeAnalytics);

function saveTestResult(wpm, accuracy) {
  const result = { wpm, accuracy }; topScores.push(result); topScores.sort((a,b)=>b.wpm-a.wpm); if(topScores.length>3) topScores=topScores.slice(0,3); localStorage.setItem('topScores', JSON.stringify(topScores)); showAnalytics(result,true);
}

document.getElementById('view-analytics-btn-top').addEventListener('click',()=>{
  if(topScores.length===0){ alert('No typing data yet. Complete at least one test first!'); return; }
  const latestResult={...topScores[topScores.length-1],current:true};
  showAnalytics(latestResult,false);
});

(function(){
  const SPIN_MS = 12000;
  const KEYS = ['Q','W','E','R','T','Y','U','I','O','P','A','S','D','F','G','H','J','K','L'];
  const ring = document.getElementById('welcome-key-ring'); const overlay = document.getElementById('welcome-overlay'); const startBtn = document.getElementById('start-btn');
  if(ring){
    const radius = 100;
    KEYS.forEach((ch,i)=>{
      const angleDeg = (i/KEYS.length)*360;
      const wrapper=document.createElement('div'); wrapper.className='key-wrapper'; wrapper.style.transform=`translate(-50%,-50%) rotate(${angleDeg}deg) translate(${radius}px)`;
      const key=document.createElement('div'); key.className='key'; key.textContent=ch;
      const start=`translate(-50%,-50%) rotate(${-angleDeg}deg)`;
      const end=`translate(-50%,-50%) rotate(${-angleDeg-360}deg)`;
      key.animate([{transform:start},{transform:end}],{duration:SPIN_MS,iterations:Infinity,easing:'linear'});
      wrapper.appendChild(key); ring.appendChild(wrapper);
    });
  }
  if(startBtn){ startBtn.addEventListener('click',()=>{ overlay.style.display='none'; if(inputArea) inputArea.focus(); }); }
})();

window.onload = ()=>{
  loadNewText();
  createKeyboard();
};

document.getElementById('view-analytics-btn-top').addEventListener('click', () => {
  if (topScores.length === 0) {
    alert('No typing data yet. Complete at least one test first!');
    return;
  }

  const existingAnalytics = document.getElementById('analytics-modal');
  if (existingAnalytics) {
    existingAnalytics.style.display = 'none';
  }

  let existingModal = document.getElementById('top3-modal');
  if (existingModal) {
    existingModal.style.display = 'flex';
    return;
  }

  const modal = document.createElement('div');
  modal.id = 'top3-modal';
  Object.assign(modal.style, {
    position: 'fixed',
    top: '0',
    left: '0',
    width: '100%',
    height: '100%',
    backgroundColor: 'rgba(0, 0, 0, 0.85)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: '9999',
  });

  const content = document.createElement('div');
  Object.assign(content.style, {
    backgroundColor: '#111',
    padding: '30px',
    borderRadius: '12px',
    color: '#fff',
    width: '90%',
    maxWidth: '500px',
    position: 'relative',
    boxShadow: '0 0 20px cyan',
  });

  const closeBtn = document.createElement('span');
  closeBtn.textContent = '✖';
  Object.assign(closeBtn.style, {
    position: 'absolute',
    top: '10px',
    right: '15px',
    fontSize: '24px',
    cursor: 'pointer',
    color: '#fff',
  });
  closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  const title = document.createElement('h2');
  title.textContent = '🏆 Top 3 Rankings';
  Object.assign(title.style, {
    textAlign: 'center',
    marginBottom: '20px',
  });

  const container = document.createElement('div');
  const topThree = topScores.slice(0, 3);

  topThree.forEach((res, index) => {
    const wrapper = document.createElement('div');
    wrapper.style.marginBottom = '15px';

    const label = document.createElement('div');
    label.textContent = `#${index + 1}`;
    label.style.marginBottom = '5px';
    label.style.fontWeight = 'bold';

    const bar = document.createElement('div');
    Object.assign(bar.style, {
      background: 'linear-gradient(to right, cyan, #00e5ff)',
      height: '20px',
      width: Math.min(res.wpm, 100) + '%',
      borderRadius: '5px',
      transition: 'width 0.4s ease-in-out',
    });

    const value = document.createElement('div');
    value.textContent = `${res.wpm} WPM | ${res.accuracy}% Accuracy`;
    Object.assign(value.style, {
      fontSize: '14px',
      marginTop: '4px',
    });

    wrapper.appendChild(label);
    wrapper.appendChild(bar);
    wrapper.appendChild(value);
    container.appendChild(wrapper);
  });

  content.appendChild(closeBtn);
  content.appendChild(title);
  content.appendChild(container);
  modal.appendChild(content);
  document.body.appendChild(modal);
});
